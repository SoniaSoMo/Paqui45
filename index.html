<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regalo de 10 Fotos üéÅ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://xelptjkyvphrzrgotxmh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlbHB0amt5dnBocnpyZ290eG1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MDA5MjIsImV4cCI6MjA4NTI3NjkyMn0.QsoiHRYGAndCzhksU5SrpyrFRcm4pdVzuDdsrJUodkA';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Contrase√±as - C√ÅMBIALAS por las que quieras
        const PASSWORDS = {
            friend: 'amiga2025',
            admin: 'admin2025'
        };

        // Estado de la aplicaci√≥n
        let photos = [];
        let userRole = null;
        let currentPassword = '';
        let showLogin = true;
        let loading = true;

        // Inicializar la aplicaci√≥n
        async function init() {
            await loadPhotos();
            render();
        }

        // Cargar fotos desde Supabase
        async function loadPhotos() {
            loading = true;
            render();
            
            try {
                const { data, error } = await supabaseClient
                    .from('photos')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error && error.code !== 'PGRST116') { // PGRST116 = tabla no existe a√∫n
                    console.error('Error al cargar fotos:', error);
                } else if (data) {
                    photos = data;
                }
            } catch (error) {
                console.error('Error:', error);
            }
            
            loading = false;
            render();
        }

        // Guardar foto en Supabase
        async function savePhoto(photoData) {
            try {
                const { data, error } = await supabaseClient
                    .from('photos')
                    .insert([photoData])
                    .select();

                if (error) {
                    console.error('Error al guardar foto:', error);
                    alert('Error al guardar la foto. Int√©ntalo de nuevo.');
                    return false;
                }

                await loadPhotos();
                return true;
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la foto. Int√©ntalo de nuevo.');
                return false;
            }
        }

        // Actualizar estado de impresi√≥n
        async function updatePrinted(id, printed) {
            try {
                const { error } = await supabaseClient
                    .from('photos')
                    .update({ printed: printed })
                    .eq('id', id);

                if (error) {
                    console.error('Error al actualizar:', error);
                    alert('Error al actualizar. Int√©ntalo de nuevo.');
                    return false;
                }

                await loadPhotos();
                return true;
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar. Int√©ntalo de nuevo.');
                return false;
            }
        }

        // Eliminar foto
        async function deletePhoto(id) {
            try {
                const { error } = await supabaseClient
                    .from('photos')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error('Error al eliminar:', error);
                    alert('Error al eliminar. Int√©ntalo de nuevo.');
                    return false;
                }

                await loadPhotos();
                return true;
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar. Int√©ntalo de nuevo.');
                return false;
            }
        }

        // Manejar login
        function handleLogin() {
            if (currentPassword === PASSWORDS.friend) {
                userRole = 'friend';
                showLogin = false;
                render();
            } else if (currentPassword === PASSWORDS.admin) {
                userRole = 'admin';
                showLogin = false;
                render();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }

        // Manejar subida de foto
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (photos.length >= 10) {
                alert('Ya has alcanzado el l√≠mite de 10 fotos');
                return;
            }

            if (file.size > 4 * 1024 * 1024) {
                alert('La foto es demasiado grande. Por favor, usa una foto de menos de 4MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const newPhoto = {
                    image_data: e.target.result,
                    upload_date: new Date().toLocaleDateString('es-ES'),
                    printed: false,
                    created_at: new Date().toISOString()
                };

                await savePhoto(newPhoto);
            };
            reader.readAsDataURL(file);
        }

        // Manejar eliminaci√≥n
        async function handleDelete(id) {
            const photo = photos.find(p => p.id === id);
            
            if (userRole === 'friend' && photo.printed) {
                alert('No puedes eliminar una foto que ya est√° impresa');
                return;
            }
            
            const confirmMessage = userRole === 'admin' && photo.printed 
                ? '¬øEst√°s seguro de que quieres eliminar esta foto IMPRESA?'
                : '¬øEst√°s segura de que quieres eliminar esta foto?';
            
            if (confirm(confirmMessage)) {
                await deletePhoto(id);
            }
        }

        // Manejar toggle de impresi√≥n
        async function handleTogglePrinted(id) {
            const photo = photos.find(p => p.id === id);
            await updatePrinted(id, !photo.printed);
        }

        // Funci√≥n de renderizado
        function render() {
            const root = document.getElementById('root');
            
            if (loading) {
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 flex items-center justify-center">
                        <div class="text-2xl text-purple-600">Cargando...</div>
                    </div>
                `;
                return;
            }

            if (showLogin) {
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">üéÅ</div>
                                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                                    Regalo de Cumplea√±os
                                </h1>
                                <p class="text-gray-600">10 Fotos Impresas Especiales</p>
                            </div>
                            
                            <div class="space-y-4">
                                <input
                                    type="password"
                                    id="password-input"
                                    placeholder="Contrase√±a"
                                    class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:outline-none focus:border-purple-400"
                                />
                                <button
                                    onclick="handleLogin()"
                                    class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-3 rounded-lg font-semibold hover:from-pink-600 hover:to-purple-600 transition-all"
                                >
                                    Entrar
                                </button>
                            </div>

                            <div class="mt-6 text-sm text-gray-500 text-center">
                                <p class="mb-1">Usa tu contrase√±a para acceder</p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('password-input').addEventListener('input', (e) => {
                    currentPassword = e.target.value;
                });

                document.getElementById('password-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });

                return;
            }

            const printedCount = photos.filter(p => p.printed).length;
            const remainingSlots = 10 - photos.length;

            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 p-4">
                    <div class="max-w-6xl mx-auto">
                        <!-- Header -->
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                        <span style="font-size: 32px">üéÅ</span>
                                        Tu Regalo de 10 Fotos
                                    </h1>
                                    <p class="text-gray-600 mt-1">
                                        ${userRole === 'admin' ? 'Vista de administrador' : '¬°Sube tus fotos favoritas!'}
                                    </p>
                                </div>
                                <button
                                    onclick="showLogin = true; userRole = null; currentPassword = ''; render();"
                                    class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    Cerrar sesi√≥n
                                </button>
                            </div>

                            <!-- Stats -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
                                <div class="bg-gradient-to-r from-pink-500 to-pink-600 rounded-xl p-4 text-white">
                                    <div class="text-3xl font-bold">${photos.length}/10</div>
                                    <div class="text-pink-100">Fotos subidas</div>
                                </div>
                                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                                    <div class="text-3xl font-bold">${printedCount}</div>
                                    <div class="text-purple-100">Ya impresas</div>
                                </div>
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                                    <div class="text-3xl font-bold">${remainingSlots}</div>
                                    <div class="text-blue-100">Espacios libres</div>
                                </div>
                            </div>
                        </div>

                        ${userRole === 'friend' && photos.length < 10 ? `
                            <div class="mb-6">
                                <label class="block bg-white rounded-2xl shadow-xl p-8 cursor-pointer hover:shadow-2xl transition-all border-4 border-dashed border-purple-200 hover:border-purple-400">
                                    <div class="text-center">
                                        <div style="font-size: 64px" class="mb-4">üì∑</div>
                                        <div class="text-xl font-semibold text-gray-700 mb-2">
                                            Subir una foto nueva
                                        </div>
                                        <div class="text-gray-500">
                                            Click aqu√≠ para seleccionar una imagen
                                        </div>
                                    </div>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onchange="handleFileUpload(event)"
                                        class="hidden"
                                    />
                                </label>
                            </div>
                        ` : ''}

                        ${photos.length === 0 ? `
                            <div class="bg-white rounded-2xl shadow-xl p-12 text-center">
                                <div style="font-size: 96px" class="mb-4">üì∑</div>
                                <p class="text-xl text-gray-500">
                                    A√∫n no hay fotos subidas
                                </p>
                                <p class="text-gray-400 mt-2">
                                    ¬°Empieza a crear tu colecci√≥n especial!
                                </p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${photos.map(photo => `
                                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden hover:shadow-2xl transition-all">
                                        <div class="relative">
                                            <img
                                                src="${photo.image_data}"
                                                alt="Foto de regalo"
                                                class="w-full h-64 object-cover"
                                            />
                                            ${photo.printed ? `
                                                <div class="absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1 shadow-lg">
                                                    ‚úì Impresa
                                                </div>
                                            ` : ''}
                                        </div>

                                        <div class="p-4">
                                            <div class="text-sm text-gray-500 mb-3">
                                                Subida: ${photo.upload_date}
                                            </div>

                                            <div class="flex gap-2">
                                                ${userRole === 'admin' ? `
                                                    <button
                                                        onclick="handleTogglePrinted(${photo.id})"
                                                        class="flex-1 py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 ${
                                                            photo.printed
                                                                ? 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                                : 'bg-green-500 text-white hover:bg-green-600'
                                                        }"
                                                    >
                                                        ${photo.printed ? '‚úó Desmarcar' : '‚úì Marcar impresa'}
                                                    </button>
                                                    <button
                                                        onclick="handleDelete(${photo.id})"
                                                        class="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition-all flex items-center justify-center gap-2"
                                                    >
                                                        üóëÔ∏è Eliminar
                                                    </button>
                                                ` : userRole === 'friend' && !photo.printed ? `
                                                    <button
                                                        onclick="handleDelete(${photo.id})"
                                                        class="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition-all flex items-center justify-center gap-2"
                                                    >
                                                        üóëÔ∏è Eliminar
                                                    </button>
                                                ` : userRole === 'friend' && photo.printed ? `
                                                    <div class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-lg text-center font-semibold">
                                                        No se puede eliminar
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}

                        ${photos.length === 10 ? `
                            <div class="mt-6 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-2xl shadow-xl p-6 text-center">
                                <div class="text-2xl font-bold text-white mb-2">
                                    üéâ ¬°Colecci√≥n completa!
                                </div>
                                <div class="text-yellow-100">
                                    Has subido las 10 fotos de tu regalo
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Iniciar la aplicaci√≥n cuando la p√°gina cargue
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
